<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>ULTIMATE_NUKETOWN_ZOMBIES</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@700&display=swap" rel="stylesheet">
    <style>
        body { margin: 0; overflow: hidden; background: #87CEEB; font-family: 'Oswald', sans-serif; }
        #ui { position: absolute; inset: 0; pointer-events: none; z-index: 10; display: flex; flex-direction: column; justify-content: space-between; padding: 25px; }
        .crosshair { position: absolute; top: 50%; left: 50%; width: 14px; height: 14px; transform: translate(-50%, -50%); border: 2px solid #00ff00; border-radius: 50%; }
        #hitmarker { position: absolute; top: 50%; left: 50%; width: 40px; height: 40px; transform: translate(-50%, -50%); opacity: 0; pointer-events: none; }
        .hm { position: absolute; width: 3px; height: 15px; background: white; left: 18px; }
        #flash { position: absolute; inset: 0; background: red; opacity: 0; pointer-events: none; }
        .stats-box { background: rgba(0,0,0,0.6); padding: 15px; border-radius: 8px; color: white; border-left: 5px solid #00f2ff; }
    </style>
</head>
<body>
    <div id="flash"></div>
    <div id="ui">
        <div class="flex justify-between items-start">
            <div class="stats-box">
                <div class="text-xl">SCORE: <span id="score-val">0</span></div>
                <div class="text-sm opacity-70">KILLS: <span id="kill-val">0</span></div>
            </div>
            <div class="text-right text-white">
                <div class="text-4xl italic">NUKETOWN Z</div>
                <div id="weapon-name" class="text-yellow-400">RIFLE</div>
            </div>
        </div>
        <div class="flex justify-between items-end">
            <div class="stats-box w-64">
                <div class="flex justify-between mb-1 text-xs"><span>HP</span><span id="hp-txt">100</span></div>
                <div class="h-2 bg-gray-800 rounded-full overflow-hidden">
                    <div id="hp-bar" class="h-full bg-green-500 w-full transition-all"></div>
                </div>
            </div>
            <div class="text-white text-6xl italic"><span id="ammo-val">30</span><span class="text-2xl opacity-50">/90</span></div>
        </div>
    </div>
    <div class="crosshair"></div>
    <div id="hitmarker">
        <div class="hm" style="transform: rotate(45deg) translateY(-12px)"></div>
        <div class="hm" style="transform: rotate(135deg) translateY(-12px)"></div>
        <div class="hm" style="transform: rotate(225deg) translateY(-12px)"></div>
        <div class="hm" style="transform: rotate(315deg) translateY(-12px)"></div>
    </div>

    <script>
        let scene, camera, renderer, gun, raycaster;
        let moveState = { fwd: false, bwd: false, l: false, r: false, jump: false };
        let vel = new THREE.Vector3(), canJump = true;
        let colliders = [], targets = [], chests = [];
        let player = { hp: 100, ammo: 30, score: 0, kills: 0, weapon: 'rifle' };

        const WEAPONS = {
            rifle: { name: "ASSAULT RIFLE", mag: 30, rate: 100, recoil: 0.03, spread: 0.02 },
            sniper: { name: "L118A SNIPER", mag: 5, rate: 1200, recoil: 0.15, spread: 0.001 }
        };

        init();
        animate();

        function init() {
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x87CEEB);
            scene.fog = new THREE.Fog(0x87CEEB, 0, 200);

            camera = new THREE.PerspectiveCamera(80, window.innerWidth/window.innerHeight, 0.1, 1000);
            camera.rotation.order = 'YXZ';
            camera.position.set(0, 1.7, 45);

            const sun = new THREE.DirectionalLight(0xffffff, 1.2);
            sun.position.set(50, 100, 50);
            scene.add(sun, new THREE.AmbientLight(0xffffff, 0.5));

            // SOL
            createBox(0, -0.5, 0, 300, 1, 300, 0x333333, false);

            // NUKETOWN MAP
            createHouse(-25, 0, 0x44aa44); // Maison Verte
            createHouse(25, 0, 0xaaaa44);  // Maison Jaune
            createBox(0, 1.5, 0, 5, 3, 12, 0x2222ff); // Bus
            createBox(12, 2, 15, 5, 4, 10, 0xdddddd); // Camion

            // SPAWN INITIAL
            for(let i=0; i<15; i++) spawnZombie();
            for(let i=0; i<5; i++) spawnChest();

            // ARME
            gun = new THREE.Group();
            const gBody = new THREE.Mesh(new THREE.BoxGeometry(0.15, 0.2, 0.9), new THREE.MeshStandardMaterial({color: 0x111111}));
            gun.add(gBody);
            scene.add(gun);

            raycaster = new THREE.Raycaster();
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            document.body.appendChild(renderer.domElement);

            // CONTROLES
            document.addEventListener('mousedown', () => { if(document.pointerLockElement) shoot(); else document.body.requestPointerLock(); });
            window.addEventListener('keydown', (e) => handleKey(e.code, true));
            window.addEventListener('keyup', (e) => handleKey(e.code, false));
            document.addEventListener('mousemove', (e) => {
                if(document.pointerLockElement) {
                    camera.rotation.y -= e.movementX * 0.002;
                    camera.rotation.x -= e.movementY * 0.002;
                    camera.rotation.x = Math.max(-1.5, Math.min(1.5, camera.rotation.x));
                }
            });
        }

        function createBox(x, y, z, w, h, d, col, isObstacle = true) {
            const mesh = new THREE.Mesh(new THREE.BoxGeometry(w, h, d), new THREE.MeshStandardMaterial({color: col}));
            mesh.position.set(x, y, z);
            scene.add(mesh);
            if(isObstacle) colliders.push(mesh);
            return mesh;
        }

        function createHouse(x, z, col) {
            createBox(x, 4, z, 18, 8, 22, col); // Main
            createBox(x, 8.5, z, 20, 1, 24, 0x222222); // Roof
        }

        function spawnZombie() {
            const z = new THREE.Mesh(new THREE.BoxGeometry(1.2, 2.5, 1.2), new THREE.MeshStandardMaterial({color: 0x1a5a1a}));
            z.position.set((Math.random()-0.5)*150, 1.25, (Math.random()-0.5)*150);
            scene.add(z);
            targets.push(z);
        }

        function spawnChest() {
            const c = new THREE.Mesh(new THREE.BoxGeometry(1.5, 1.5, 1.5), new THREE.MeshStandardMaterial({color: 0xffaa00, emissive: 0xffaa00, emissiveIntensity: 0.5}));
            c.position.set((Math.random()-0.5)*100, 0.75, (Math.random()-0.5)*100);
            scene.add(c);
            chests.push(c);
        }

        function handleKey(code, val) {
            if(code === 'KeyW' || code === 'KeyZ') moveState.fwd = val;
            if(code === 'KeyS') moveState.bwd = val;
            if(code === 'KeyA' || code === 'KeyQ') moveState.l = val;
            if(code === 'KeyD') moveState.r = val;
            if(code === 'Space') moveState.jump = val;
            if(val && code === 'Digit1') switchWeapon('rifle');
            if(val && code === 'Digit2') switchWeapon('sniper');
        }

        function switchWeapon(type) {
            player.weapon = type;
            player.ammo = WEAPONS[type].mag;
            document.getElementById('weapon-name').innerText = WEAPONS[type].name;
            updateHUD();
        }

        function shoot() {
            if(player.ammo <= 0) return;
            const w = WEAPONS[player.weapon];
            player.ammo--;
            updateHUD();
            
            gun.position.z += w.recoil * 5; // Kickback

            raycaster.setFromCamera(new THREE.Vector2(0,0), camera);
            const hits = raycaster.intersectObjects([...colliders, ...targets]);

            if(hits.length > 0) {
                const hit = hits[0];
                if(targets.includes(hit.object)) {
                    scene.remove(hit.object);
                    targets = targets.filter(t => t !== hit.object);
                    player.score += 100; player.kills++;
                    showHitmarker();
                    spawnZombie();
                    updateHUD();
                }
            }
        }

        function showHitmarker() {
            const h = document.getElementById('hitmarker');
            h.style.opacity = '1';
            setTimeout(() => h.style.opacity = '0', 100);
        }

        function updateHUD() {
            document.getElementById('ammo-val').innerText = player.ammo;
            document.getElementById('score-val').innerText = player.score;
            document.getElementById('kill-val').innerText = player.kills;
            document.getElementById('hp-bar').style.width = player.hp + '%';
            document.getElementById('hp-txt').innerText = Math.ceil(player.hp);
        }

        function animate() {
            requestAnimationFrame(animate);
            
            // PHYSIQUE KRUNKER
            const friction = 0.92;
            const speed = 0.025;
            if(moveState.fwd) vel.z -= speed;
            if(moveState.bwd) vel.z += speed;
            if(moveState.l) vel.x -= speed;
            if(moveState.r) vel.x += speed;

            vel.x *= friction; vel.z *= friction;
            if(moveState.jump && canJump) { vel.y = 0.25; canJump = false; }
            vel.y -= 0.01; // GravitÃ©

            // COLLISIONS MURS
            const nextPos = camera.position.clone().add(new THREE.Vector3(vel.x, 0, vel.z).applyQuaternion(camera.quaternion));
            let blocked = false;
            colliders.forEach(c => { if(nextPos.distanceTo(c.position) < 5) blocked = true; });

            if(!blocked) camera.position.add(new THREE.Vector3(vel.x, 0, vel.z).applyQuaternion(camera.quaternion));
            camera.position.y += vel.y;

            if(camera.position.y < 1.7) { camera.position.y = 1.7; vel.y = 0; canJump = true; }

            // IA ZOMBIES (Ne traversent pas les murs)
            targets.forEach(z => {
                const toP = new THREE.Vector3().subVectors(camera.position, z.position).normalize();
                const nextZ = z.position.clone().addScaledVector(toP, 0.07);
                let zBlocked = false;
                colliders.forEach(c => { if(nextZ.distanceTo(c.position) < 5.5) zBlocked = true; });
                if(!zBlocked) z.position.copy(nextZ);
                
                if(z.position.distanceTo(camera.position) < 2) {
                    player.hp -= 0.5;
                    document.getElementById('flash').style.opacity = 0.3;
                    setTimeout(() => document.getElementById('flash').style.opacity = 0, 50);
                    updateHUD();
                    if(player.hp <= 0) location.reload();
                }
            });

            // CHESTS
            chests.forEach((c, i) => {
                c.rotation.y += 0.05;
                if(camera.position.distanceTo(c.position) < 2.5) {
                    player.ammo = Math.min(player.ammo + 30, 90);
                    scene.remove(c); chests.splice(i,1); spawnChest();
                    updateHUD();
                }
            });

            // GUN FOLLOW
            gun.position.copy(camera.position);
            gun.quaternion.copy(camera.quaternion);
            gun.translateX(0.35); gun.translateY(-0.25); gun.translateZ(-0.7);
            gun.position.lerp(camera.position, 0.1);

            renderer.render(scene, camera);
        }
    </script>
</body>
</html>
